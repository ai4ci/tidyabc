<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Calculate a Wasserstein distance — calculate_wasserstein • tidyabc</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calculate a Wasserstein distance — calculate_wasserstein"><meta name="description" content="This function takes simulation and observed data and calculates a normalised
Wasserstein distance."><meta property="og:description" content="This function takes simulation and observed data and calculates a normalised
Wasserstein distance."><meta property="og:image" content="https://ai4ci.github.io/tidyabc/logo.svg"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidyabc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9003</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/tidyabc.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/abc-adaptive.html">ABC Adaptive</a></li>
    <li><a class="dropdown-item" href="../articles/abc-smc.html">ABC Sequential Monte-Carlo</a></li>
    <li><a class="dropdown-item" href="../articles/s3-distributions.html">Statistical distribution functions</a></li>
    <li><a class="dropdown-item" href="../articles/scorer-functions.html">Scoring and summarising functions</a></li>
    <li><a class="dropdown-item" href="../articles/sim-example.html">Early outbreak and Generation time</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ai4ci/tidyabc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Calculate a Wasserstein distance</h1>
      <small class="dont-index">Source: <a href="https://github.com/ai4ci/tidyabc/blob/HEAD/R/calculate-wasserstein.R" class="external-link"><code>R/calculate-wasserstein.R</code></a></small>
      <div class="d-none name"><code>calculate_wasserstein.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function takes simulation and observed data and calculates a normalised
Wasserstein distance.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">calculate_wasserstein</span><span class="op">(</span><span class="va">sim</span>, <span class="va">obs</span>, debias <span class="op">=</span> <span class="cn">FALSE</span>, bootstraps <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-sim">sim<a class="anchor" aria-label="anchor" href="#arg-sim"></a></dt>
<dd><p>A vector of simulated data points</p></dd>


<dt id="arg-obs">obs<a class="anchor" aria-label="anchor" href="#arg-obs"></a></dt>
<dd><p>A vector of observed data points</p></dd>


<dt id="arg-debias">debias<a class="anchor" aria-label="anchor" href="#arg-debias"></a></dt>
<dd><p>Should the simulations be shifted to match the mean of the
observed data</p></dd>


<dt id="arg-bootstraps">bootstraps<a class="anchor" aria-label="anchor" href="#arg-bootstraps"></a></dt>
<dd><p>Randomly resample from the simulated data points to match
the observed size this many times and combine the output by averaging. The
alternative, when this is 1 (the default) matches the sizes by selecting
and/or repeating the simulated data points in order (deterministically)</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>a length normalised wasserstein distance. This is the average distance an
individual simulated data point must be shifted to match the observed data normalised
by the average distance of the observed data from the mean.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>In the comparison unequal lengths of the data can be accommodated. The
simulated data is sorted and linearly interpolated to the same length as the
observed data before the comparison.</p>
<p>$$
W = \frac{1}{N_{obs} \cdot \sigma_{obs}} \sum_{i=1}^{N_{obs}} | \hat{x}_i - y_i |
$$</p>
<p>where \(y_i\) are the ordered observed data points, \(\hat{x}_i\) are the
simulated data points after matching size (potentially via interpolation),
debiasing (optional), and sorting, \(N_{obs}\) is the number of observed
points, and \(\sigma_{obs}\) is the standard deviation of the observed data
(used for normalisation).</p>
<p>Size matching via linear interpolation:</p>
<p>Let \(x\) be the sorted simulated
data of length \(N_{sim}\), and \(N_{obs}\) be the target length.</p>
<p>Indices \(idx\) are generated as \(idx = \frac{(i-1) \cdot (N_{sim} - 1)}{N_{obs} - 1} + 1\)
for \(i = 1, ..., N_{obs}\). Then \(\hat{x}_i\) is calculated as:</p>
<p>$$
\hat{x}_i = (1 - p_i) \cdot x_{\lfloor idx_i \rfloor} + p_i \cdot x_{\lceil idx_i \rceil}
$$</p>
<p>where \(p_i = idx_i - \lfloor idx_i \rfloor\). If \(\lfloor idx_i \rfloor = \lceil idx_i \rceil\),
then \(\hat{x}_i = x_{\lfloor idx_i \rfloor}\).</p>
<p>For bootstrapping (<code>bootstraps &gt; 1</code>), the process is repeated <code>bootstraps</code>
times with random sampling, and the final distance is the average of the results.</p>
    </div>
    <div class="section level2">
    <h2 id="unit-tests">Unit tests<a class="anchor" aria-label="anchor" href="#unit-tests"></a></h2>
    <p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">calculate_wasserstein</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">10</span><span class="sc">:</span><span class="dv">0</span>), <span class="dv">0</span>)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co"># zero if no distance</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">calculate_wasserstein</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>), <span class="dv">0</span>)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">calculate_wasserstein</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">0</span>, <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>), <span class="dv">0</span>)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co"># normalised so that all mass at mean = 1</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">calculate_wasserstein</span>(<span class="fu">rep</span>(<span class="dv">5</span>, <span class="dv">11</span>), <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>), <span class="dv">1</span>)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="co"># smaller sample recycled and normalises to same value</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">calculate_wasserstein</span>(<span class="fu">rep</span>(<span class="dv">5</span>, <span class="dv">5</span>), <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>), <span class="dv">1</span>)</span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="co"># should be ((0+1+0+1+0+0+0+1+0+1+0) / 11) / ((5+4+3+2+1+0+1+2+3+4+5) / 11) = 0.1333...</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="fu">calculate_wasserstein</span>(</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>    <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">10</span>),</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>    <span class="dv">0</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a> ),</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>  <span class="fl">0.133333333333333</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>)</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>withr<span class="sc">::</span><span class="fu">with_seed</span>(<span class="dv">100</span>, {</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>   ref <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>   cmp1 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>   cmp2 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>, <span class="at">sd=</span><span class="dv">2</span>)</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>   cmp3 <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>})</span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">calculate_wasserstein</span>(cmp1,ref), <span class="fl">0.0576417503974498</span>)</span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">calculate_wasserstein</span>(cmp2,ref), <span class="fl">1.04950621760385</span>)</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">expect_equal</span>(<span class="fu">calculate_wasserstein</span>(cmp3,ref), <span class="fl">0.212977231452674</span>)</span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(cmp1,ref,<span class="at">bootstraps=</span><span class="dv">10</span>)</span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a>gen <span class="ot">=</span> <span class="cf">function</span>(n, <span class="at">mean=</span><span class="dv">0</span>, <span class="at">sd=</span><span class="dv">1</span>) {</span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a>  <span class="fu">sample</span>(<span class="fu">pnorm</span>(<span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="at">length.out =</span> n <span class="sc">-</span> n</span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a><span class="co"># there should be approximately zero</span></span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">1000</span>), <span class="fu">gen</span>(<span class="dv">1000</span>))</span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">1000</span>), <span class="fu">gen</span>(<span class="dv">100</span>))</span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">100</span>), <span class="fu">gen</span>(<span class="dv">1000</span>))</span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">200</span>), <span class="fu">gen</span>(<span class="dv">1000</span>))</span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a><span class="co"># these should be approximately equal:</span></span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">100</span>,<span class="fl">0.1</span>), <span class="fu">gen</span>(<span class="dv">1000</span>))</span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">200</span>,<span class="fl">0.1</span>), <span class="fu">gen</span>(<span class="dv">1000</span>))</span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">1000</span>,<span class="fl">0.1</span>), <span class="fu">gen</span>(<span class="dv">1000</span>))</span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">1000</span>, <span class="fl">0.1</span>), <span class="fu">gen</span>(<span class="dv">200</span>))</span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a><span class="fu">calculate_wasserstein</span>(<span class="fu">gen</span>(<span class="dv">1000</span>, <span class="fl">0.1</span>), <span class="fu">gen</span>(<span class="dv">100</span>))</span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a></span></code></pre><p></p></div>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robert Challen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

