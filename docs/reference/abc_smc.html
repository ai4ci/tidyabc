<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Perform ABC sequential Monte Carlo fitting — abc_smc • tidyabc</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Perform ABC sequential Monte Carlo fitting — abc_smc"><meta name="description" content="This function will execute a simulation for a random selection of parameters.
Based on the acceptance_rate it will reject a proportion of the results.
The remaining results are weighted (using a kernel with a tolerance
equivalent to half the acceptance rate). Weighted parameter particles
generate proposals for further waves but a particle perturbation. Waves
are executed until a maximum is reached or the results converge sufficiently
that the changes between waves are small. A relatively small number of
simulations may be attempted with a high acceptance rate, over multiple waves."><meta property="og:description" content="This function will execute a simulation for a random selection of parameters.
Based on the acceptance_rate it will reject a proportion of the results.
The remaining results are weighted (using a kernel with a tolerance
equivalent to half the acceptance rate). Weighted parameter particles
generate proposals for further waves but a particle perturbation. Waves
are executed until a maximum is reached or the results converge sufficiently
that the changes between waves are small. A relatively small number of
simulations may be attempted with a high acceptance rate, over multiple waves."><meta property="og:image" content="https://ai4ci.github.io/tidyabc/logo.svg"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tidyabc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/tidyabc.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/abc-adaptive.html">ABC Adaptive</a></li>
    <li><a class="dropdown-item" href="../articles/abc-smc.html">ABC Sequential Monte-Carlo</a></li>
    <li><a class="dropdown-item" href="../articles/s3-distributions.html">Statistical distribution functions</a></li>
    <li><a class="dropdown-item" href="../articles/scorer-functions.html">Simulation, scoring and convergence functions</a></li>
    <li><a class="dropdown-item" href="../articles/sim-example.html">Early outbreak and Generation time</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ai4ci/tidyabc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Perform ABC sequential Monte Carlo fitting</h1>
      <small class="dont-index">Source: <a href="https://github.com/ai4ci/tidyabc/blob/HEAD/R/abc-workflow.R" class="external-link"><code>R/abc-workflow.R</code></a></small>
      <div class="d-none name"><code>abc_smc.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function will execute a simulation for a random selection of parameters.
Based on the <code>acceptance_rate</code> it will reject a proportion of the results.
The remaining results are weighted (using a kernel with a tolerance
equivalent to half the acceptance rate). Weighted parameter particles
generate proposals for further waves but a particle perturbation. Waves
are executed until a maximum is reached or the results converge sufficiently
that the changes between waves are small. A relatively small number of
simulations may be attempted with a high acceptance rate, over multiple waves.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">abc_smc</span><span class="op">(</span></span>
<span>  <span class="va">obsdata</span>,</span>
<span>  <span class="va">priors_list</span>,</span>
<span>  <span class="va">sim_fn</span>,</span>
<span>  <span class="va">scorer_fn</span>,</span>
<span>  <span class="va">n_sims</span>,</span>
<span>  <span class="va">acceptance_rate</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  max_time <span class="op">=</span> <span class="fl">5</span> <span class="op">*</span> <span class="fl">60</span>,</span>
<span>  converged_fn <span class="op">=</span> <span class="fu"><a href="default_termination_fn.html">default_termination_fn</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  obsscores <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  distance_method <span class="op">=</span> <span class="st">"euclidean"</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  allow_continue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interactive.html" class="external-link">interactive</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  debug_errors <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  kernel <span class="op">=</span> <span class="st">"epanechnikov"</span>,</span>
<span>  scoreweights <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-obsdata">obsdata<a class="anchor" aria-label="anchor" href="#arg-obsdata"></a></dt>
<dd><p>The observational data. The data in this will typically
be a named list, but could be anything, e.g. dataframe. It is the reference
data that the simulation model is aiming to replicate.</p></dd>


<dt id="arg-priors-list">priors_list<a class="anchor" aria-label="anchor" href="#arg-priors-list"></a></dt>
<dd><p>a named list of priors specified as a <code>abc_prior</code> S3 object
(see <code><a href="priors.html">priors()</a></code>), this can include derived values as unnamed 2-sided
formulae, where the LHS of the formula will be assigned to the value of the
RHS, plus optionally a set of constraints as one sided formulae where the
RHS of the formulae will resolve to a boolean value.</p></dd>


<dt id="arg-sim-fn">sim_fn<a class="anchor" aria-label="anchor" href="#arg-sim-fn"></a></dt>
<dd><p>a user defined function that takes a set of parameters named
the same as <code>priors_list</code>. It must return a simulated data set in the
same format as <code>obsdata</code>, or that can be compared to <code>simdata</code> by
<code>scorer_fn</code>. This function must not refer to global parameters, and will be
automatically crated with <code>carrier</code>.</p></dd>


<dt id="arg-scorer-fn">scorer_fn<a class="anchor" aria-label="anchor" href="#arg-scorer-fn"></a></dt>
<dd><p>a user supplied function that matches the following
signature <code>scorer_fn(simdata, obsdata, ....)</code>, i.e. it takes data in the
format of <code>simdata</code> paired with the original <code>obsdata</code> and returns a named
list of component scores per simulation. This function can make use of the
<code>calculate_*()</code> set of functions to compare components of the simulation to
the original data. This function must not refer to global parameters, and
will be automatically crated with <code>carrier</code>. If this is a purrr style
function then <code>.x</code> will refer to simulation output and <code>.y</code> to original
observation data.</p></dd>


<dt id="arg-n-sims">n_sims<a class="anchor" aria-label="anchor" href="#arg-n-sims"></a></dt>
<dd><p>The number of simulations to run per wave (for SMC and Adaptive)
or overall (for Rejection). For rejection sampling a large number is
recommended, for the others sma</p></dd>


<dt id="arg-acceptance-rate">acceptance_rate<a class="anchor" aria-label="anchor" href="#arg-acceptance-rate"></a></dt>
<dd><p>What proportion of simulations to keep in ABC rejection
or hard ABC parts of the algorithms.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>must be empty</p></dd>


<dt id="arg-max-time">max_time<a class="anchor" aria-label="anchor" href="#arg-max-time"></a></dt>
<dd><p>the maximum time in seconds to spend in ABC waves before admitting
defeat. This time may not be all used if the algorithm converges.</p></dd>


<dt id="arg-converged-fn">converged_fn<a class="anchor" aria-label="anchor" href="#arg-converged-fn"></a></dt>
<dd><p>a function that takes a <code>summary</code> and <code>per_param</code> input
and generates a logical indicator that the function has converged</p></dd>


<dt id="arg-obsscores">obsscores<a class="anchor" aria-label="anchor" href="#arg-obsscores"></a></dt>
<dd><p>Summary scores for the observational data. This will
be a named list, and is equivalent to the output of <code>scorer_fn</code>,
on the observed data. If not given typically it will be assumed to be all
zeros.</p></dd>


<dt id="arg-distance-method">distance_method<a class="anchor" aria-label="anchor" href="#arg-distance-method"></a></dt>
<dd><p>what metric is used to combine <code>simscores</code> and <code>obsscores</code>.
One of <code>"euclidean"</code>, <code>"normalised"</code>, <code>"manhattan"</code>, or <code>"mahalanobis"</code>.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>an optional random seed</p></dd>


<dt id="arg-parallel">parallel<a class="anchor" aria-label="anchor" href="#arg-parallel"></a></dt>
<dd><p>parallelise the simulation? If this is set to true then the
simulation step will be parallelised using <code>furrr</code>. For this to make any
difference it must have been set up with the following:
<code>future::plan(future::multisession, workers = parallel::detectCores()-2)</code></p></dd>


<dt id="arg-allow-continue">allow_continue<a class="anchor" aria-label="anchor" href="#arg-allow-continue"></a></dt>
<dd><p>if SMC or adaptive algorithms have not converged after
<code>max_time</code> allow the algorithm to interactively prompt the user to continue.</p></dd>


<dt id="arg-debug-errors">debug_errors<a class="anchor" aria-label="anchor" href="#arg-debug-errors"></a></dt>
<dd><p>Errors that crop up in <code>sim_fn</code> during a simulation due
to anomolous value combinations are hard to debug. If this flag is set,
whenever a <code>sim_fn</code> or <code>scorer_fn</code> throws an error an interactive debugging
session is started with the failing parameter combinations. This is not
compatible with running in parallel.</p></dd>


<dt id="arg-kernel">kernel<a class="anchor" aria-label="anchor" href="#arg-kernel"></a></dt>
<dd><p>one of <code>"epanechnikov"</code> (default), <code>"uniform"</code>, <code>"triangular"</code>,
<code>"biweight"</code>, or <code>"gaussian"</code>. The kernel defines how the distance metric
translates into the importance weight that decides whether a given
simulation and associated parameters should be rejected or held for the
next round. All kernels except <code>gaussian</code> have a hard cut-off outside of
which the probability of acceptance of a particle is zero. Use of
<code>gaussian</code> kernels can result in poor convergence.</p></dd>


<dt id="arg-scoreweights">scoreweights<a class="anchor" aria-label="anchor" href="#arg-scoreweights"></a></dt>
<dd><p>A named vector with names matching output of <code>scorer_fn</code>
that defines the importance of this component of the scoring in the overall
distance and weighting of any given simulation. This can be used to assign
more weight on certain parts of the model output. For <code>euclidean</code> and <code>manhattan</code>
distance methods these weights multiply the output of <code>scorer_fn</code> directly.
For the other 2 distance methods some degree of normalisation is done first
on the first wave scores to make different components have approximately the
same relevance to the overall score.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>an S3 object of class <code>abc_fit</code> this contains the following:</p><ul><li><p>type: the type of ABC algorithm</p></li>
<li><p>iterations: number of completed iterations</p></li>
<li><p>converged: boolean - did the result meet convergence criteria</p></li>
<li><p>waves: a list of dataframes of wave convergence metrics</p></li>
<li><p>summary: a dataframe with the summary of the parameter fits after each wave.</p></li>
<li><p>priors: the priors for the fit as a <code>abc_prior</code> S3 object</p></li>
<li><p>posteriors: the final wave posteriors</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Performs the ABC Sequential Monte Carlo (SMC) algorithm.
This iterative method refines parameter estimates across multiple waves.</p><ol><li><p><strong>Initialization (Wave 1):</strong>
Parameters \(\theta^{(i)}\) are sampled from the prior \(P(\theta)\).
Simulations \(D_s^{(i)} = M(\theta^{(i)})\) are run, summaries \(S_s^{(i)}\)
are computed, and distances \(d^{(i)} = d(S_s^{(i)}, S_o)\) are calculated.
A tolerance threshold \(\epsilon_1\) is set as the
\(\alpha = \texttt{acceptance\_rate}\) quantile of these initial distances.
Unnormalized weights \(\tilde{w}^{(i)}_1\) are calculated using a kernel
\(K_{\epsilon_1}(d^{(i)})\).</p></li>
<li><p><strong>Subsequent Waves (\(t &gt; 1\)):</strong></p><ul><li><p><strong>Proposal Generation:</strong> A particle \(\theta^{(j)}_{t-1}\) is selected
from the previous wave's accepted particles with probability proportional
to its weight \(w^{(j)}_{t-1}\). The particle is then perturbed in a
transformed MVN space using a multivariate normal kernel with covariance
\(\Sigma_t = \frac{\kappa_t^2}{d} \text{Cov}_{w_{t-1}}(\theta_{t-1})\),
where \(\text{Cov}_{w_{t-1}}\) is the weighted covariance from wave \(t-1\),
\(d\) is the parameter dimension, and \(\kappa_t\) is the <code>kernel_t</code> parameter.
The new proposal \(\theta^{(i)}_t\) is generated as:
$$
       \theta^{(i)}_t = \theta^{(j)}_{t-1} + \zeta, \quad \zeta \sim \mathcal{N}(0, \Sigma_t)
     $$
This proposal is mapped back to the original parameter space using the
prior's copula transformation (from MVN space defined by prior CDFs).</p></li>
<li><p><strong>Simulation and Weighting:</strong> Simulations \(D_s^{(i)} = M(\theta^{(i)}_t)\)
are run for the new proposals. Distances \(d^{(i)}_t\) are computed.
The tolerance \(\epsilon_t\) is set as the \(\alpha\)-quantile of
distances from the <em>current</em> wave's simulations. The unnormalized weight
for particle \(i\) in wave \(t\) is calculated as:
$$
       \tilde{w}^{(i)}_t = \frac{P(\theta^{(i)}_t) K_{\epsilon_t}(d^{(i)}_t)}{q_t(\theta^{(i)}_t)}
     $$
where \(P(\theta^{(i)}_t)\) is the prior density, \(K_{\epsilon_t}\)
is the ABC kernel, and \(q_t(\theta^{(i)}_t)\) is the proposal density
from the previous wave's weighted particles (calculated using the
perturbation kernel). This proposal density is computed as a weighted sum:
$$
       q_t(\theta^{(i)}_t) = \sum_j w^{(j)}_{t-1} \phi(\theta^{(i)}_t; \theta^{(j)}_{t-1}, \Sigma_t)
     $$
where \(\phi(\cdot; \mu, \Sigma)\) is the PDF of a multivariate normal
with mean \(\mu\) and covariance \(\Sigma\).</p></li>
</ul></li>
<li><p><strong>Normalization:</strong> Weights \(w^{(i)}_t\) are normalized to sum to one.
Particles with negligible weights are typically filtered out.</p></li>
<li><p><strong>Termination:</strong> The process repeats until a maximum number of waves or
time is reached, or convergence criteria are met based on changes in
parameter estimates or effective sample size (ESS).</p></li>
</ol></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">fit</span> <span class="op">=</span> <span class="fu">abc_smc</span><span class="op">(</span></span></span>
<span class="r-in"><span>  obsdata <span class="op">=</span> <span class="fu"><a href="example_fns.html">example_obsdata</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  priors_list <span class="op">=</span> <span class="fu"><a href="example_fns.html">example_priors_list</a></span><span class="op">(</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  sim_fn <span class="op">=</span> <span class="va">example_sim_fn</span>,</span></span>
<span class="r-in"><span>  scorer_fn <span class="op">=</span> <span class="va">example_scorer_fn</span>,</span></span>
<span class="r-in"><span>  n_sims <span class="op">=</span> <span class="fl">1000</span>,</span></span>
<span class="r-in"><span>  acceptance_rate <span class="op">=</span> <span class="fl">0.25</span>,</span></span>
<span class="r-in"><span>  max_time <span class="op">=</span> <span class="fl">5</span>, <span class="co"># 5 seconds to fit within examples limit</span></span></span>
<span class="r-in"><span>  parallel <span class="op">=</span> <span class="cn">FALSE</span>,</span></span>
<span class="r-in"><span>  allow_continue <span class="op">=</span> <span class="cn">FALSE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> ABC-SMC</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> SMC waves:  <span style="color: #00BB00;">■■■■■■■■■■                      </span>  29% | wave 2 ETA:  4s</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> SMC waves:  <span style="color: #00BB00;">■■■■■■■■■■■■■■■                 </span>  47% | wave 3 ETA:  3s</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> SMC waves:  <span style="color: #00BB00;">■■■■■■■■■■■■■■■■■■■■            </span>  62% | wave 4 ETA:  2s</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> SMC waves:  <span style="color: #00BB00;">■■■■■■■■■■■■■■■■■■■■■■■■        </span>  77% | wave 5 ETA:  1s</span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> SMC waves:  <span style="color: #00BB00;">■■■■■■■■■■■■■■■■■■■■■■■■■■■■    </span>  90% | wave 6 ETA:  0s</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ABC SMC fit: 7 waves - (not yet converged)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Parameter estimates:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 3 × 4</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># Groups:   param [3]</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   param mean_sd       median_95_CrI           ESS</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span> mean  4.977 ± 0.034 4.976 [4.893 — 5.060]  267.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span> sd1   1.980 ± 0.093 1.975 [1.754 — 2.248]  267.</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span> sd2   0.992 ± 0.042 0.990 [0.888 — 1.102]  267.</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Robert Challen.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

